<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dizi Fingering Chart</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .key-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key-selector label {
            font-size: 0.9rem;
        }

        .key-selector select {
            font-size: 1rem;
            padding: 5px 12px;
            border-radius: 6px;
            border: 2px solid #f39c12;
            background: #1a1a2e;
            color: #fff;
            cursor: pointer;
            outline: none;
        }

        .info-box {
            font-size: 0.85rem;
            color: #f39c12;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-hole {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #888;
        }

        .legend-hole.closed {
            background: #e74c3c;
        }

        .legend-hole.open {
            background: transparent;
        }

        .legend-hole.half {
            background: linear-gradient(90deg, #e74c3c 50%, transparent 50%);
        }

        .section-title {
            font-size: 0.85rem;
            color: #888;
            margin: 15px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .fingering-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .fingering-card {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            width: 58px;
        }

        .fingering-card.chromatic {
            background: rgba(255,255,255,0.02);
            border-color: rgba(255,255,255,0.05);
        }

        .note-name {
            font-size: 1rem;
            font-weight: bold;
            color: #f39c12;
            line-height: 1.1;
        }

        .chromatic .note-name {
            color: #9b59b6;
        }

        .note-octave {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 4px;
        }

        .dizi-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .hole {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #666;
        }

        .hole.closed {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .hole.open {
            background: transparent;
        }

        .hole.half {
            background: linear-gradient(90deg, #e74c3c 50%, transparent 50%);
            border-color: #c0392b;
        }

        .technique-note {
            font-size: 0.5rem;
            color: #666;
            margin-top: 2px;
        }

        footer {
            text-align: center;
            margin-top: 15px;
            font-size: 0.7rem;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dizi Fingering Chart</h1>
        </header>

        <div class="top-bar">
            <div class="key-selector">
                <label for="key-select">Key:</label>
                <select id="key-select">
                    <option value="0">C</option>
                    <option value="1">C#/Db</option>
                    <option value="2">D</option>
                    <option value="3">D#/Eb</option>
                    <option value="4">E</option>
                    <option value="5" selected>F</option>
                    <option value="6">F#/Gb</option>
                    <option value="7">G</option>
                    <option value="8">G#/Ab</option>
                    <option value="9">A</option>
                    <option value="10">A#/Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            <div class="info-box">
                筒音 = <span id="筒音">C</span>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-hole closed"></div>
                    <span>Closed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-hole open"></div>
                    <span>Open</span>
                </div>
                <div class="legend-item">
                    <div class="legend-hole half"></div>
                    <span>Half</span>
                </div>
            </div>
        </div>

        <div class="section-title">Diatonic Notes</div>
        <div class="fingering-grid" id="diatonic-grid"></div>

        <div class="section-title">Chromatic Notes</div>
        <div class="fingering-grid" id="chromatic-grid"></div>

        <footer>
            Holes 1-6 from bottom to top | Higher octave: faster air, tighter embouchure
        </footer>
    </div>

    <script>
        // Note names with sharps vs flats depending on key
        const noteNamesSharps = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteNamesFlats = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        // Keys that use flats: F, Bb, Eb, Ab, Db, Gb (indices 5, 10, 3, 8, 1, 6)
        const flatKeys = [5, 10, 3, 8, 1, 6];

        function getNoteNames(keyOffset) {
            return flatKeys.includes(keyOffset) ? noteNamesFlats : noteNamesSharps;
        }

        // Diatonic fingerings (relative to ROOT note, semitone 0 = key)
        // Based on D Qudi fingering chart (Yueqi, Thrasher & Wong, 2011)
        // Key insight: all open = #4, NOT 5. The 5th requires overblowing.
        const diatonicFingerings = [
            // 1st octave
            { semitones: -5, holes: [1, 1, 1, 1, 1, 1], octave: '1', degree: '5' },   // Low 5 (筒音)
            { semitones: -3, holes: [1, 1, 1, 1, 1, 0], octave: '1', degree: '6' },   // Low 6
            { semitones: -1, holes: [1, 1, 1, 1, 0, 0], octave: '1', degree: '7' },   // Low 7
            { semitones: 0,  holes: [1, 1, 1, 0, 0, 0], octave: '1', degree: '1' },   // 1 (ROOT)
            { semitones: 2,  holes: [1, 1, 0, 0, 0, 0], octave: '1', degree: '2' },   // 2
            { semitones: 4,  holes: [1, 0, 0, 0, 0, 0], octave: '1', degree: '3' },   // 3
            { semitones: 5,  holes: [0, 1, 1, 0, 0, 0], octave: '1', degree: '4' },   // 4 (forked)
            // 2nd octave (overblown) - hole 6 open triggers 2nd register
            { semitones: 7,  holes: [0, 1, 1, 1, 1, 1], octave: '2', degree: '5' },   // 5 (overblown!)
            { semitones: 9,  holes: [0, 1, 1, 1, 1, 0], octave: '2', degree: '6' },   // 6
            { semitones: 11, holes: [0, 1, 1, 1, 0, 0], octave: '2', degree: '7' },   // 7
            { semitones: 12, holes: [0, 1, 1, 0, 0, 0], octave: '2', degree: '1' },   // High 1
            { semitones: 14, holes: [0, 1, 0, 0, 0, 0], octave: '2', degree: '2' },   // High 2
            { semitones: 16, holes: [0, 0, 0, 0, 0, 0], octave: '2', degree: '3' },   // High 3 (all open, overblown)
        ];

        // Chromatic fingerings (relative to ROOT note, semitone 0 = key)
        const chromaticFingerings = [
            // 1st octave chromatics
            { semitones: -4, holes: [1, 1, 1, 1, 1, 0.5], octave: '1', degree: '#5', technique: '½' },  // Low #5
            { semitones: -2, holes: [1, 1, 1, 1, 0.5, 0], octave: '1', degree: 'b7', technique: '½' },  // Low b7
            { semitones: 1,  holes: [1, 1, 0.5, 0, 0, 0], octave: '1', degree: '#1', technique: '½' },  // #1
            { semitones: 3,  holes: [1, 0.5, 0, 0, 0, 0], octave: '1', degree: 'b3', technique: '½' },  // b3
            { semitones: 6,  holes: [0, 1, 0, 0, 0, 0], octave: '1', degree: '#4', technique: '½' },    // #4 (alt)
            { semitones: 6,  holes: [0, 0, 0, 0, 0, 0], octave: '1', degree: '#4' },                    // #4 (all open!)
            // 2nd octave chromatics
            { semitones: 8,  holes: [0, 1, 1, 1, 1, 0.5], octave: '2', degree: '#5', technique: '½' },  // #5
            { semitones: 10, holes: [0, 1, 1, 1, 0.5, 0], octave: '2', degree: 'b7', technique: '½' },  // b7
            { semitones: 13, holes: [0, 1, 0.5, 0, 0, 0], octave: '2', degree: '#1', technique: '½' },  // High #1
            { semitones: 15, holes: [0, 0.5, 0, 0, 0, 0], octave: '2', degree: 'b3', technique: '½' },  // High b3
        ];

        function getNoteName(keyOffset, semitoneOffset) {
            // Handle negative semitones with +12 to ensure positive modulo
            const noteIndex = ((keyOffset + semitoneOffset) % 12 + 12) % 12;
            const noteNames = getNoteNames(keyOffset);
            return noteNames[noteIndex];
        }

        function createFingeringCard(fingering, keyOffset, isChromatic) {
            const noteName = getNoteName(keyOffset, fingering.semitones);
            const degree = fingering.degree || '';

            const card = document.createElement('div');
            card.className = 'fingering-card' + (isChromatic ? ' chromatic' : '');

            let holesHtml = '';
            for (let i = 0; i < 6; i++) {
                const holeValue = fingering.holes[i];
                let holeClass = 'hole ';
                if (holeValue === 1) holeClass += 'closed';
                else if (holeValue === 0) holeClass += 'open';
                else holeClass += 'half';
                holesHtml += `<div class="${holeClass}"></div>`;
            }

            let techniqueHtml = fingering.technique ?
                `<div class="technique-note">${fingering.technique}</div>` : '';

            card.innerHTML = `
                <div class="note-name">${noteName}</div>
                <div class="note-octave">${fingering.octave} · ${degree}</div>
                <div class="dizi-diagram">${holesHtml}</div>
                ${techniqueHtml}
            `;

            return card;
        }

        function updateChart() {
            const keySelect = document.getElementById('key-select');
            const keyOffset = parseInt(keySelect.value);
            const noteNames = getNoteNames(keyOffset);

            // 筒音 (fundamental) is 5 semitones below the key/root
            const fundamentalIndex = ((keyOffset - 5) % 12 + 12) % 12;
            const fundamentalName = noteNames[fundamentalIndex];
            document.getElementById('筒音').textContent = fundamentalName;

            const diatonicGrid = document.getElementById('diatonic-grid');
            const chromaticGrid = document.getElementById('chromatic-grid');
            diatonicGrid.innerHTML = '';
            chromaticGrid.innerHTML = '';

            diatonicFingerings.forEach(f => {
                diatonicGrid.appendChild(createFingeringCard(f, keyOffset, false));
            });

            chromaticFingerings.forEach(f => {
                chromaticGrid.appendChild(createFingeringCard(f, keyOffset, true));
            });
        }

        document.getElementById('key-select').addEventListener('change', updateChart);
        updateChart();
    </script>
</body>
</html>
