<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dizi Fingering Chart</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            margin: 0;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 10px;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            background: linear-gradient(90deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .top-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .key-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key-selector label {
            font-size: 0.9rem;
        }

        .key-selector select {
            font-size: 1rem;
            padding: 5px 12px;
            border-radius: 6px;
            border: 2px solid #f39c12;
            background: #1a1a2e;
            color: #fff;
            cursor: pointer;
            outline: none;
        }

        .info-box {
            font-size: 0.85rem;
            color: #f39c12;
        }

        .legend {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 12px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-hole {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #888;
        }

        .legend-hole.closed {
            background: #e74c3c;
        }

        .legend-hole.open {
            background: transparent;
        }

        .legend-hole.half {
            background: linear-gradient(90deg, #e74c3c 50%, transparent 50%);
        }

        .section-title {
            font-size: 0.85rem;
            color: #888;
            margin: 15px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .section-title:first-of-type {
            margin-top: 0;
        }

        .fingering-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .fingering-card {
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 6px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            width: 58px;
        }

        .fingering-card.chromatic {
            background: rgba(255,255,255,0.02);
            border-color: rgba(255,255,255,0.05);
        }

        .note-name {
            font-size: 1rem;
            font-weight: bold;
            color: #f39c12;
            line-height: 1.1;
        }

        .chromatic .note-name {
            color: #9b59b6;
        }

        .note-octave {
            font-size: 0.6rem;
            color: #666;
            margin-bottom: 4px;
        }

        .dizi-diagram {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .hole {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #666;
        }

        .hole.closed {
            background: #e74c3c;
            border-color: #c0392b;
        }

        .hole.open {
            background: transparent;
        }

        .hole.half {
            background: linear-gradient(90deg, #e74c3c 50%, transparent 50%);
            border-color: #c0392b;
        }

        .technique-note {
            font-size: 0.5rem;
            color: #666;
            margin-top: 2px;
        }

        .fingering-card.highlighted {
            box-shadow: 0 0 12px #f39c12;
            border-color: #f39c12;
            transform: scale(1.08);
            transition: all 0.1s ease-out;
        }

        .melody-section {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            padding: 10px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
        }

        .melody-selector select {
            font-size: 0.9rem;
            padding: 5px 10px;
            border-radius: 6px;
            border: 2px solid #9b59b6;
            background: #1a1a2e;
            color: #fff;
            cursor: pointer;
            outline: none;
        }

        .melody-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .melody-controls button {
            padding: 6px 14px;
            border-radius: 6px;
            border: none;
            background: #f39c12;
            color: #1a1a2e;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .melody-controls button:hover {
            background: #e67e22;
        }

        .melody-controls button:disabled {
            background: #555;
            cursor: not-allowed;
        }

        .tempo-control {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
        }

        .tempo-control input[type="range"] {
            width: 80px;
            accent-color: #f39c12;
        }

        .tempo-value {
            color: #f39c12;
            min-width: 45px;
        }

        footer {
            text-align: center;
            margin-top: 15px;
            font-size: 0.7rem;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Dizi Fingering Chart</h1>
        </header>

        <div class="top-bar">
            <div class="key-selector">
                <label for="key-select">Key:</label>
                <select id="key-select">
                    <option value="0">C</option>
                    <option value="1">C#/Db</option>
                    <option value="2">D</option>
                    <option value="3">D#/Eb</option>
                    <option value="4">E</option>
                    <option value="5" selected>F</option>
                    <option value="6">F#/Gb</option>
                    <option value="7">G</option>
                    <option value="8">G#/Ab</option>
                    <option value="9">A</option>
                    <option value="10">A#/Bb</option>
                    <option value="11">B</option>
                </select>
            </div>
            <div class="info-box">
                筒音 = <span id="筒音">C</span>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-hole closed"></div>
                    <span>Closed</span>
                </div>
                <div class="legend-item">
                    <div class="legend-hole open"></div>
                    <span>Open</span>
                </div>
                <div class="legend-item">
                    <div class="legend-hole half"></div>
                    <span>Half</span>
                </div>
            </div>
        </div>

        <div class="melody-section">
            <div class="melody-selector">
                <select id="melody-select">
                    <option value="0">Amazing Grace</option>
                    <option value="1">Oh! Susanna</option>
                    <option value="2">Home on the Range</option>
                    <option value="3">Simple Gifts</option>
                    <option value="4">Twinkle Twinkle</option>
                </select>
            </div>
            <div class="melody-controls">
                <button id="play-btn">▶ Play</button>
                <button id="stop-btn">■ Stop</button>
            </div>
            <div class="tempo-control">
                <label>Tempo:</label>
                <input type="range" id="tempo-slider" min="60" max="180" value="100">
                <span class="tempo-value" id="tempo-display">100 BPM</span>
            </div>
        </div>

        <div class="section-title">Diatonic Notes</div>
        <div class="fingering-grid" id="diatonic-grid"></div>

        <div class="section-title">Chromatic Notes</div>
        <div class="fingering-grid" id="chromatic-grid"></div>

        <footer>
            Holes 1-6 from bottom to top | Higher octave: faster air, tighter embouchure
        </footer>
    </div>

    <script>
        // Note names with sharps vs flats depending on key
        const noteNamesSharps = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const noteNamesFlats = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        // Keys that use flats: F, Bb, Eb, Ab, Db, Gb (indices 5, 10, 3, 8, 1, 6)
        const flatKeys = [5, 10, 3, 8, 1, 6];

        function getNoteNames(keyOffset) {
            return flatKeys.includes(keyOffset) ? noteNamesFlats : noteNamesSharps;
        }

        // Diatonic fingerings (relative to ROOT note, semitone 0 = key)
        // Based on D Qudi fingering chart (Yueqi, Thrasher & Wong, 2011)
        // Key insight: all open = #4, NOT 5. The 5th requires overblowing.
        const diatonicFingerings = [
            // 1st octave
            { semitones: -5, holes: [1, 1, 1, 1, 1, 1], octave: '1', degree: '5' },   // Low 5 (筒音)
            { semitones: -3, holes: [1, 1, 1, 1, 1, 0], octave: '1', degree: '6' },   // Low 6
            { semitones: -1, holes: [1, 1, 1, 1, 0, 0], octave: '1', degree: '7' },   // Low 7
            { semitones: 0,  holes: [1, 1, 1, 0, 0, 0], octave: '1', degree: '1' },   // 1 (ROOT)
            { semitones: 2,  holes: [1, 1, 0, 0, 0, 0], octave: '1', degree: '2' },   // 2
            { semitones: 4,  holes: [1, 0, 0, 0, 0, 0], octave: '1', degree: '3' },   // 3
            { semitones: 5,  holes: [0, 1, 1, 0, 0, 0], octave: '1', degree: '4' },   // 4 (forked)
            // 2nd octave (overblown) - hole 6 open triggers 2nd register
            { semitones: 7,  holes: [0, 1, 1, 1, 1, 1], octave: '2', degree: '5' },   // 5 (overblown!)
            { semitones: 9,  holes: [0, 1, 1, 1, 1, 0], octave: '2', degree: '6' },   // 6
            { semitones: 11, holes: [0, 1, 1, 1, 0, 0], octave: '2', degree: '7' },   // 7
            { semitones: 12, holes: [0, 1, 1, 0, 0, 0], octave: '2', degree: '1' },   // High 1
            { semitones: 14, holes: [0, 1, 0, 0, 0, 0], octave: '2', degree: '2' },   // High 2
            { semitones: 16, holes: [0, 0, 0, 0, 0, 0], octave: '2', degree: '3' },   // High 3 (all open, overblown)
        ];

        // Chromatic fingerings (relative to ROOT note, semitone 0 = key)
        const chromaticFingerings = [
            // 1st octave chromatics
            { semitones: -4, holes: [1, 1, 1, 1, 1, 0.5], octave: '1', degree: '#5', technique: '½' },  // Low #5
            { semitones: -2, holes: [1, 1, 1, 1, 0.5, 0], octave: '1', degree: 'b7', technique: '½' },  // Low b7
            { semitones: 1,  holes: [1, 1, 0.5, 0, 0, 0], octave: '1', degree: '#1', technique: '½' },  // #1
            { semitones: 3,  holes: [1, 0.5, 0, 0, 0, 0], octave: '1', degree: 'b3', technique: '½' },  // b3
            { semitones: 6,  holes: [0, 1, 0, 0, 0, 0], octave: '1', degree: '#4', technique: '½' },    // #4 (alt)
            { semitones: 6,  holes: [0, 0, 0, 0, 0, 0], octave: '1', degree: '#4' },                    // #4 (all open!)
            // 2nd octave chromatics
            { semitones: 8,  holes: [0, 1, 1, 1, 1, 0.5], octave: '2', degree: '#5', technique: '½' },  // #5
            { semitones: 10, holes: [0, 1, 1, 1, 0.5, 0], octave: '2', degree: 'b7', technique: '½' },  // b7
            { semitones: 13, holes: [0, 1, 0.5, 0, 0, 0], octave: '2', degree: '#1', technique: '½' },  // High #1
            { semitones: 15, holes: [0, 0.5, 0, 0, 0, 0], octave: '2', degree: 'b3', technique: '½' },  // High b3
        ];

        // Melodies encoded as [degree, octave, duration in beats]
        // Degrees: 1-7 for diatonic scale, negative for rests
        const melodies = [
            {
                name: "Amazing Grace",
                tempo: 72,
                notes: [
                    // Amazing grace, how sweet the sound
                    [5, 1, 1], [1, 2, 2], [3, 2, 0.5], [1, 2, 0.5], [3, 2, 2], [2, 2, 1],
                    [1, 2, 2], [6, 1, 1], [5, 1, 2], [-1, 1, 1],
                    // That saved a wretch like me
                    [5, 1, 1], [1, 2, 2], [3, 2, 0.5], [1, 2, 0.5], [3, 2, 2], [2, 2, 1],
                    [5, 2, 3], [-1, 1, 1],
                    // I once was lost but now am found
                    [5, 2, 1], [3, 2, 2], [5, 2, 0.5], [3, 2, 0.5], [5, 2, 2], [3, 2, 1],
                    [1, 2, 2], [6, 1, 1], [5, 1, 2], [-1, 1, 1],
                    // Was blind but now I see
                    [5, 1, 1], [1, 2, 2], [3, 2, 0.5], [1, 2, 0.5], [3, 2, 2], [2, 2, 1],
                    [1, 2, 3]
                ]
            },
            {
                name: "Oh! Susanna",
                tempo: 120,
                notes: [
                    // I come from Alabama with my banjo on my knee
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [5, 2, 1], [5, 2, 0.5], [6, 2, 0.5], [5, 2, 1], [3, 2, 1],
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 1], [2, 2, 2],
                    // I'm going to Louisiana my true love for to see
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [5, 2, 1], [5, 2, 0.5], [6, 2, 0.5], [5, 2, 1], [3, 2, 1],
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [3, 2, 1], [2, 2, 1], [2, 2, 1], [1, 2, 2],
                    // Oh Susanna, don't you cry for me
                    [4, 2, 1], [4, 2, 1], [6, 2, 2], [6, 2, 1], [5, 2, 1], [3, 2, 2],
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 1], [2, 2, 2],
                    // For I come from Alabama with my banjo on my knee
                    [4, 2, 1], [4, 2, 1], [6, 2, 2], [6, 2, 1], [5, 2, 1], [3, 2, 1], [3, 2, 1],
                    [1, 2, 0.5], [2, 2, 0.5], [3, 2, 1], [3, 2, 1], [2, 2, 1], [2, 2, 1], [1, 2, 2]
                ]
            },
            {
                name: "Home on the Range",
                tempo: 90,
                notes: [
                    // Oh give me a home where the buffalo roam
                    [1, 2, 1], [1, 2, 2], [3, 2, 1], [5, 2, 2], [5, 2, 1],
                    [6, 2, 2], [5, 2, 1], [3, 2, 2], [1, 2, 1],
                    // Where the deer and the antelope play
                    [2, 2, 2], [2, 2, 1], [4, 2, 2], [3, 2, 1],
                    [2, 2, 2], [1, 2, 1], [7, 1, 3],
                    // Where seldom is heard a discouraging word
                    [7, 1, 1], [1, 2, 2], [3, 2, 1], [5, 2, 2], [5, 2, 1],
                    [6, 2, 2], [5, 2, 1], [3, 2, 3],
                    // And the skies are not cloudy all day
                    [5, 2, 2], [3, 2, 1], [2, 2, 2], [1, 2, 1],
                    [2, 2, 2], [3, 2, 1], [1, 2, 3]
                ]
            },
            {
                name: "Simple Gifts",
                tempo: 100,
                notes: [
                    // 'Tis the gift to be simple, 'tis the gift to be free
                    [5, 1, 1], [1, 2, 1], [1, 2, 1], [1, 2, 1], [2, 2, 1], [3, 2, 1], [3, 2, 1], [3, 2, 1],
                    [2, 2, 1], [3, 2, 1], [4, 2, 1], [5, 2, 1], [5, 2, 2],
                    // 'Tis the gift to come down where we ought to be
                    [5, 2, 1], [5, 2, 1], [6, 2, 1], [5, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 2],
                    [2, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 1], [6, 1, 1], [5, 1, 1], [5, 1, 2],
                    // And when we find ourselves in the place just right
                    [5, 1, 1], [1, 2, 1], [1, 2, 1], [1, 2, 1], [2, 2, 1], [3, 2, 1], [3, 2, 1], [3, 2, 1],
                    [2, 2, 1], [3, 2, 1], [4, 2, 1], [5, 2, 1], [5, 2, 2],
                    // 'Twill be in the valley of love and delight
                    [5, 2, 1], [5, 2, 1], [6, 2, 1], [5, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 2],
                    [2, 2, 1], [3, 2, 1], [2, 2, 1], [1, 2, 1], [1, 2, 3]
                ]
            },
            {
                name: "Twinkle Twinkle",
                tempo: 100,
                notes: [
                    // Twinkle twinkle little star
                    [1, 2, 1], [1, 2, 1], [5, 2, 1], [5, 2, 1], [6, 2, 1], [6, 2, 1], [5, 2, 2],
                    // How I wonder what you are
                    [4, 2, 1], [4, 2, 1], [3, 2, 1], [3, 2, 1], [2, 2, 1], [2, 2, 1], [1, 2, 2],
                    // Up above the world so high
                    [5, 2, 1], [5, 2, 1], [4, 2, 1], [4, 2, 1], [3, 2, 1], [3, 2, 1], [2, 2, 2],
                    // Like a diamond in the sky
                    [5, 2, 1], [5, 2, 1], [4, 2, 1], [4, 2, 1], [3, 2, 1], [3, 2, 1], [2, 2, 2],
                    // Twinkle twinkle little star
                    [1, 2, 1], [1, 2, 1], [5, 2, 1], [5, 2, 1], [6, 2, 1], [6, 2, 1], [5, 2, 2],
                    // How I wonder what you are
                    [4, 2, 1], [4, 2, 1], [3, 2, 1], [3, 2, 1], [2, 2, 1], [2, 2, 1], [1, 2, 2]
                ]
            }
        ];

        // Map scale degree + octave to semitones from root
        function degreeToSemitones(degree, octave) {
            if (degree < 0) return null; // Rest
            const degreeMap = { 1: 0, 2: 2, 3: 4, 4: 5, 5: 7, 6: 9, 7: 11 };
            const baseSemitones = degreeMap[degree] || 0;
            if (octave === 1) return baseSemitones - 12; // Low octave
            if (octave === 2) return baseSemitones;      // Middle octave
            return baseSemitones + 12;                   // High octave
        }

        // Flute synthesizer using Web Audio API
        class FluteSynth {
            constructor() {
                this.audioContext = null;
                this.activeNodes = [];
            }

            init() {
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                if (this.audioContext.state === 'suspended') {
                    this.audioContext.resume();
                }
            }

            getFrequency(keyOffset, semitones) {
                // A4 = 440Hz, calculate frequency for any note
                // Key F (5) at root (semitones 0) = F4 = 349.23 Hz
                const rootFreq = 440 * Math.pow(2, (keyOffset - 9) / 12); // F4 when keyOffset=5
                return rootFreq * Math.pow(2, semitones / 12);
            }

            playNote(frequency, duration, startTime) {
                const ctx = this.audioContext;

                // Main oscillator (sine for flute-like pure tone)
                const osc1 = ctx.createOscillator();
                osc1.type = 'sine';
                osc1.frequency.value = frequency;

                // Second harmonic (octave, quieter)
                const osc2 = ctx.createOscillator();
                osc2.type = 'sine';
                osc2.frequency.value = frequency * 2;

                // Third harmonic (even quieter)
                const osc3 = ctx.createOscillator();
                osc3.type = 'sine';
                osc3.frequency.value = frequency * 3;

                // Gain nodes for mixing harmonics
                const gain1 = ctx.createGain();
                const gain2 = ctx.createGain();
                const gain3 = ctx.createGain();

                gain1.gain.value = 0.5;
                gain2.gain.value = 0.15;
                gain3.gain.value = 0.05;

                // Master envelope
                const envelope = ctx.createGain();
                envelope.gain.setValueAtTime(0, startTime);
                envelope.gain.linearRampToValueAtTime(0.4, startTime + 0.05); // Attack
                envelope.gain.exponentialRampToValueAtTime(0.3, startTime + 0.1); // Decay
                envelope.gain.setValueAtTime(0.3, startTime + duration - 0.05); // Sustain
                envelope.gain.exponentialRampToValueAtTime(0.001, startTime + duration); // Release

                // Connect oscillators through gains to envelope
                osc1.connect(gain1).connect(envelope);
                osc2.connect(gain2).connect(envelope);
                osc3.connect(gain3).connect(envelope);
                envelope.connect(ctx.destination);

                // Schedule start/stop
                osc1.start(startTime);
                osc2.start(startTime);
                osc3.start(startTime);
                osc1.stop(startTime + duration);
                osc2.stop(startTime + duration);
                osc3.stop(startTime + duration);

                this.activeNodes.push(osc1, osc2, osc3);
            }

            stop() {
                this.activeNodes.forEach(node => {
                    try { node.stop(); } catch (e) {}
                });
                this.activeNodes = [];
            }
        }

        // Melody player with highlighting
        class MelodyPlayer {
            constructor() {
                this.synth = new FluteSynth();
                this.isPlaying = false;
                this.timeouts = [];
            }

            play(melodyIndex, keyOffset, tempo) {
                this.stop();
                this.synth.init();
                this.isPlaying = true;

                const melody = melodies[melodyIndex];
                const beatsPerSecond = tempo / 60;
                let currentTime = this.synth.audioContext.currentTime + 0.1;
                const startTime = currentTime;

                melody.notes.forEach((note, i) => {
                    const [degree, octave, beats] = note;
                    const duration = beats / beatsPerSecond;
                    const semitones = degreeToSemitones(degree, octave);

                    if (semitones !== null) {
                        const freq = this.synth.getFrequency(keyOffset, semitones);
                        this.synth.playNote(freq, duration * 0.9, currentTime);

                        // Schedule highlighting
                        const highlightDelay = (currentTime - startTime) * 1000;
                        const timeout = setTimeout(() => {
                            if (this.isPlaying) highlightFingering(semitones);
                        }, highlightDelay);
                        this.timeouts.push(timeout);
                    }

                    currentTime += duration;
                });

                // Schedule end
                const endTimeout = setTimeout(() => {
                    this.isPlaying = false;
                    clearHighlight();
                    updatePlayButton();
                }, (currentTime - startTime) * 1000);
                this.timeouts.push(endTimeout);
            }

            stop() {
                this.isPlaying = false;
                this.synth.stop();
                this.timeouts.forEach(t => clearTimeout(t));
                this.timeouts = [];
                clearHighlight();
            }
        }

        // Highlighting functions
        function highlightFingering(semitones) {
            clearHighlight();
            const card = document.querySelector(`[data-semitones="${semitones}"]`);
            if (card) {
                card.classList.add('highlighted');
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function clearHighlight() {
            document.querySelectorAll('.fingering-card.highlighted').forEach(c => {
                c.classList.remove('highlighted');
            });
        }

        // Global player instance
        const player = new MelodyPlayer();

        function updatePlayButton() {
            const btn = document.getElementById('play-btn');
            btn.textContent = player.isPlaying ? '⏸ Pause' : '▶ Play';
        }

        function getNoteName(keyOffset, semitoneOffset) {
            // Handle negative semitones with +12 to ensure positive modulo
            const noteIndex = ((keyOffset + semitoneOffset) % 12 + 12) % 12;
            const noteNames = getNoteNames(keyOffset);
            return noteNames[noteIndex];
        }

        function createFingeringCard(fingering, keyOffset, isChromatic) {
            const noteName = getNoteName(keyOffset, fingering.semitones);
            const degree = fingering.degree || '';

            const card = document.createElement('div');
            card.className = 'fingering-card' + (isChromatic ? ' chromatic' : '');
            card.dataset.semitones = fingering.semitones;

            let holesHtml = '';
            for (let i = 0; i < 6; i++) {
                const holeValue = fingering.holes[i];
                let holeClass = 'hole ';
                if (holeValue === 1) holeClass += 'closed';
                else if (holeValue === 0) holeClass += 'open';
                else holeClass += 'half';
                holesHtml += `<div class="${holeClass}"></div>`;
            }

            let techniqueHtml = fingering.technique ?
                `<div class="technique-note">${fingering.technique}</div>` : '';

            card.innerHTML = `
                <div class="note-name">${noteName}</div>
                <div class="note-octave">${fingering.octave} · ${degree}</div>
                <div class="dizi-diagram">${holesHtml}</div>
                ${techniqueHtml}
            `;

            return card;
        }

        function updateChart() {
            const keySelect = document.getElementById('key-select');
            const keyOffset = parseInt(keySelect.value);
            const noteNames = getNoteNames(keyOffset);

            // 筒音 (fundamental) is 5 semitones below the key/root
            const fundamentalIndex = ((keyOffset - 5) % 12 + 12) % 12;
            const fundamentalName = noteNames[fundamentalIndex];
            document.getElementById('筒音').textContent = fundamentalName;

            const diatonicGrid = document.getElementById('diatonic-grid');
            const chromaticGrid = document.getElementById('chromatic-grid');
            diatonicGrid.innerHTML = '';
            chromaticGrid.innerHTML = '';

            diatonicFingerings.forEach(f => {
                diatonicGrid.appendChild(createFingeringCard(f, keyOffset, false));
            });

            chromaticFingerings.forEach(f => {
                chromaticGrid.appendChild(createFingeringCard(f, keyOffset, true));
            });
        }

        document.getElementById('key-select').addEventListener('change', updateChart);
        updateChart();

        // Melody playback controls
        const tempoSlider = document.getElementById('tempo-slider');
        const tempoDisplay = document.getElementById('tempo-display');

        tempoSlider.addEventListener('input', () => {
            tempoDisplay.textContent = `${tempoSlider.value} BPM`;
        });

        document.getElementById('play-btn').addEventListener('click', () => {
            if (player.isPlaying) {
                player.stop();
            } else {
                const melodyIndex = parseInt(document.getElementById('melody-select').value);
                const keyOffset = parseInt(document.getElementById('key-select').value);
                const tempo = parseInt(tempoSlider.value);
                player.play(melodyIndex, keyOffset, tempo);
            }
            updatePlayButton();
        });

        document.getElementById('stop-btn').addEventListener('click', () => {
            player.stop();
            updatePlayButton();
        });

        // Stop playback when key changes
        document.getElementById('key-select').addEventListener('change', () => {
            player.stop();
            updatePlayButton();
        });
    </script>
</body>
</html>
